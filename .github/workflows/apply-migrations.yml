name: Apply Database Migrations

# This workflow applies database migrations to the Neon PostgreSQL database
# It runs when migration files change or can be triggered manually

on:
  # Allow manual triggering from GitHub Actions UI
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (check status only, no changes)'
        required: false
        type: boolean
        default: false
  
  # Auto-run when migration files are pushed to main
  push:
    branches:
      - main
    paths:
      - 'database/migrations/*.sql'
      - 'database/schema-postgres.sql'
      - 'scripts/apply-migrations.js'

jobs:
  migrate:
    name: Apply Database Migrations
    runs-on: ubuntu-latest
    
    steps:
      - name: Check for DATABASE_URL
        id: check-db
        env:
          DB_URL: ${{ secrets.DATABASE_URL }}
        run: |
          if [ -z "$DB_URL" ]; then
            echo "âš ï¸ DATABASE_URL not configured, skipping migrations"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… DATABASE_URL is configured"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        if: steps.check-db.outputs.skip != 'true'
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        if: steps.check-db.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        if: steps.check-db.outputs.skip != 'true'
        run: npm ci
      
      - name: Check migration status
        if: steps.check-db.outputs.skip != 'true'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "ðŸ” Checking current migration status..."
          node scripts/apply-all-migrations.js || echo "Migration check completed"
      
      - name: Apply migrations (if not dry-run)
        if: ${{ steps.check-db.outputs.skip != 'true' && !inputs.dry_run }}
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "ðŸš€ Applying database migrations..."
          npm run migrate:all
      
      - name: Dry-run completed
        if: ${{ steps.check-db.outputs.skip != 'true' && inputs.dry_run }}
        run: |
          echo "âœ… Dry-run mode: No changes applied"
          echo "Migration status check completed successfully"
      
      - name: Migration summary
        if: always()
        run: |
          echo "## Migration Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run**: ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "âœ… **Status**: Dry-run completed (no changes applied)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Status**: Migrations applied successfully" >> $GITHUB_STEP_SUMMARY
          fi
